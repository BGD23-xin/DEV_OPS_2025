# Opensearh

OpenSearch 可以理解为由AWS来托管的Elastc search 服务，它能扩容，冷热存储来优化存储，从而节约成本。

## 配置

有两种创建模式
- 轻松创建（需要VPC至少有3个可用区）
- 标准创建 (推荐)
- 模版（生产和开发测试）
- 部署（待机和不带待机） # 不待机时，可用区可以调节，区别是不开待机，节点会一直运行。
- 版本选择（推荐2.19）# firehose手动创建时，无法识别最新版。如果需要和ELK同步数据时，需要开兼容模式
- 数据节点数（磁盘类型一般选gp3）
    - 类型选择
    - 节点数 (最小值为可用区数)
    - IOPS（每秒读写的Input/Output次数）# 1GB 存储 ，IOPS 最大合理值 500
    - 吞吐量 # 吞吐量最大为 IOPS的 1/4
- 专用协调器节点（在有大量查询时可以使用）
- 自定义端点（绑定一个域名来访问）
- 网络（域放置的网络环境，一般选择私有子网）
- 精细访问控制（配置一个超级账户，之后可以创建多个账户，建议开且选择创建主用户）
- 访问策略（建议 使用精细访问控制）


写入关系时 IOPS * IO大小（KB） = 吞吐量


## 排查问题

### 写入 


几个重要的指标：
- 集群状态：
 - 集群写入状态（红色，写入被暂停）
- 关键性能指标
 - 索引写入速度（firehose的发送量不变，但这个指标下降，说明吞吐瓶颈）
 - 索引延迟 （>100ms 并上升， IOPS 不足或 分片合并拖慢写入）
- 数据节点
 - cpu利用率 （> 85% 则  CPU 饱和， 若同时索引写入速度 降低，则CPU限制写入）
 - JVM内存压力（> 80% 线程紧张）
- JVM 线程池
 - 写入线程池（正常为0，若拉满，则已达节点处理上限）


一般解决思路是：
- 对上游输入端
 - 调大 缓冲区
    
- 对索引设置 
 - 调高 刷新时间
 - 增加分片数量
 - 适当降低 副本数量 

如果上述无法解决，需要调整结构
 - rollover ：索引的切换（防止索引过大）
 - 固定映射（即固定写入的字段）
 - 冷热分层

启用冷热分层，如现有节点数为1，会启用节点为6（3个主节点和3个warm节点），共计7个节点（这个功能可以在数据量大于`1Tb`时开启）
如果数据量低于 1 tb,建议2个节点即可。具体视情况而定。


```bash
# 在opensearch中的dev tools查看分片情况
GET /test_1150_s-2025-10-21/_settings
```
